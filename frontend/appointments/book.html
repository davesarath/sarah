{% extends "layouts/owner_base.html" %}

{% block title %}Pet Care Management - Book Appointment{% endblock %}

{% block page_title %}ðŸ“… Book Appointment{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <form action="/book_appointment" method="POST">
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Select Pet</label>
            <select class="form-select" name="pet_id" required>
              <option value="">Choose your pet...</option>
              {% for pet in pets %}
                    <option value="{{ pet.pet_id }}" 
                      {% if pet_id|string == pet.pet_id|string %}selected{% endif %}>
                      {{ pet.name }} ({{ pet.breed }})
                    </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Veterinarian</label>
            <input type="text" id="vetSearch" class="form-control" placeholder="Search veterinarian..." autocomplete="off" required>
            <input type="hidden" id="vet_id" name="vet_id"  value="{{ vet_id or '' }}" required>
            <ul id="vetSuggestions" class="list-group position-absolute w-100" style="z-index:1000;"></ul>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Appointment Date</label>
            <input type="date" class="form-control" name="appointment_date"  value="{{ appointment_date or '' }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Appointment Time</label>
            <input type="time" class="form-control" name="appointment_time"  value="{{ appointment_time or '' }}" required>
          </div>
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary">Book Appointment</button>
        <a href="/appointments" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const vetInput = document.getElementById("vetSearch");
    const vetSuggestions = document.getElementById("vetSuggestions");
    const vetIdInput = document.getElementById("vet_id");
    let selectedVetId = {{ vet_id or 'null' }};
    const vetName = '{{ vet_name or "" }}';
    if (vetName) {
      vetInput.value = vetName;
    }

    vetInput.addEventListener("input", async () => {
      const query = vetInput.value.trim();
      selectedVetId = null;
      vetIdInput.value = "";

      if (query.length < 0) {
        vetSuggestions.innerHTML = "";
        return;
      }

      try {
        const response = await fetch(`/autocomplete_users?q=${encodeURIComponent(query)}&role=${encodeURIComponent("Veterinarian")}`);
        const vets = await response.json();

        vetSuggestions.innerHTML = "";
        vets.forEach(vet => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          li.textContent = `${vet.full_name} - ${vet.specialization || 'General'} (${vet.email})`;
          li.onclick = () => {
            vetInput.value = vet.full_name;
            selectedVetId = vet.vet_id;
            vetIdInput.value = vet.vet_id;
            vetSuggestions.innerHTML = "";
          };
          vetSuggestions.appendChild(li);
        });
      } catch (error) {
        console.error('Error fetching veterinarians:', error);
      }
    });

    // Validate vet selection on blur
    vetInput.addEventListener('blur', function() {
      setTimeout(() => {
        if (!selectedVetId && vetInput.value.trim()) {
          vetInput.value = '';
          vetIdInput.value = "";
        }
      }, 200);
    });

    // Hide suggestions when clicking outside
    document.addEventListener("click", (e) => {
      if (!vetSuggestions.contains(e.target) && e.target !== vetInput) {
        vetSuggestions.innerHTML = "";
      }
    });

    // Set minimum date to today
    const dateInput = document.querySelector('input[name="appointment_date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInput.min = today;
  });
</script>
{% endblock %}