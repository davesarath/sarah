{% extends "layouts/admin_base.html" %}

{% block title %}Pet Care Management - Manage Users{% endblock %}

{% block page_title %}ğŸ‘¥ Manage Users{% endblock %}

{% block content %}
<div class="d-flex justify-content-end mb-3">
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#editUserModal" onclick="addUser()">
    â• Add New User
  </button>
</div>

<div class="card">
  <div class="card-body">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ user.full_name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.role }}</td>
          <td>{{ user.status }}</td>
          <td>
            <a href="javascript:void(0)" class="btn btn-primary btn-sm" onclick='viewUser({{ user | tojson }})'>View</a>
            <a href="javascript:void(0)" class="btn btn-warning btn-sm" onclick='editUser({{ user | tojson }})'>Edit</a>
            <a href="javascript:void(0)" class="btn btn-danger btn-sm" onclick='deleteUser({{ user | tojson }})'>Delete</a>
          </td>
        </tr>
        {% endfor %}
        
        {% if not users %}
        <tr>
          <td colspan="6" class="text-center text-muted">No users added yet</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- EDIT USER MODAL -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="user-form" action="/manage_edit_user" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">âœï¸ Edit User</h5>
          <h5 class="modal-title" id="addUserModalLabel">âœï¸ Add User</h5>
          <h5 class="modal-title" id="userUserModalLabel">ğŸ‘ï¸ View User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="edit_user_id" name="user_id">

          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="full_name" name="full_name" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="edit_email" name="email" required readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone</label>
            <input type="number" class="form-control" id="edit_phone" name="phone">
          </div>

          <div class="mb-3">
            <label class="form-label">Specialization</label>
            <input type="text" class="form-control" id="edit_specialization" name="specialization">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Address</label>
            <input type="text" class="form-control" id="edit_address" name="address">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select class="form-select" id="edit_role" name="role" required>
              <option>Admin</option>
              <option>Veterinarian</option>
              <option>Pet Owner</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="edit_status" name="status" required>
              <option>Active</option>
              <option>Inactive</option>
            </select>
          </div>

          <div class="mb-3" id="password-grp">
            <label class="form-label">Password (leave blank to keep current)</label>
            <input type="password" class="form-control" id="edit_password" name="password"
              placeholder="Enter new password (optional)">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" id="btn-user-close" onclick="setUserFormDefault()" class="btn btn-secondary"
            data-bs-dismiss="modal">Close</button>
          <button type="submit" id="btn-user-submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function viewUser(objUser) {
    // Fill modal inputs
    document.getElementById("edit_user_id").value = objUser.user_id;
    document.getElementById("full_name").value = objUser.full_name;
    document.getElementById("edit_email").value = objUser.email;
    document.getElementById("edit_role").value = objUser.role;
    document.getElementById("edit_status").value = objUser.status;
    document.getElementById("edit_address").value = objUser.address;
    document.getElementById("edit_phone").value = objUser.phone;
    document.getElementById("edit_specialization").value = objUser.specialization;
    document.getElementById("edit_password").value = "";

    document.getElementById("password-grp").style.display = "none";
    document.getElementById("btn-user-submit").style.display = "none";
    document.getElementById("editUserModalLabel").style.display = "none";
    document.getElementById("addUserModalLabel").style.display = "none";
    document.getElementById("userUserModalLabel").style.display = "block";

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("editUserModal"));
    modal.show();
  }

  function editUser(objUser) {
    // Fill modal inputs
    document.getElementById("edit_user_id").value = objUser.user_id;
    document.getElementById("full_name").value = objUser.full_name;
    document.getElementById("edit_email").value = objUser.email;
    document.getElementById("edit_address").value = objUser.address;
    document.getElementById("edit_phone").value = objUser.phone;
    document.getElementById("edit_specialization").value = objUser.specialization;
    document.getElementById("edit_role").value = objUser.role;
    document.getElementById("edit_status").value = objUser.status;
    document.getElementById("edit_password").value = "";
    document.getElementById("password-grp").style.display = "block";

    document.getElementById("editUserModalLabel").style.display = "block";
    document.getElementById("addUserModalLabel").style.display = "none";
    document.getElementById("userUserModalLabel").style.display = "none";
    document.getElementById("btn-user-submit").style.display = "block";
    document.getElementById("btn-user-submit").innerText = "Update";
    document.getElementById("user-form").action = "/manage_edit_user";

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("editUserModal"));
    modal.show();
  }

  function addUser() {
    // Fill modal inputs
    document.getElementById("edit_user_id").value = "";
    document.getElementById("full_name").value = "";
    document.getElementById("edit_email").value = "";
    document.getElementById("edit_address").value = "";
    document.getElementById("edit_phone").value = "";
    document.getElementById("edit_specialization").value = "";
    document.getElementById("edit_role").value = "";
    document.getElementById("edit_status").value = "";
    document.getElementById("edit_password").value = "";
    document.getElementById("password-grp").style.display = "block";

    document.getElementById("editUserModalLabel").style.display = "none";
    document.getElementById("addUserModalLabel").style.display = "block";
    document.getElementById("userUserModalLabel").style.display = "none";
    document.getElementById("btn-user-submit").style.display = "block";
    document.getElementById("btn-user-submit").innerText = "Save";
    document.getElementById("user-form").action = "/manage_add_user";
    const emailInput = document.getElementById("edit_email");

    if (emailInput.hasAttribute("readonly")) {
      // Make editable
      emailInput.removeAttribute("readonly");
    }
    const passwordInput = document.getElementById("edit_password");
    passwordInput.setAttribute("required", true);
    passwordInput.placeholder = "";
    document.getElementById("password-grp").getElementsByTagName("label")[0].innerText = "Password"
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("editUserModal"));
    modal.show();
  }

  function setUserFormDefault() {
    const emailInput = document.getElementById("edit_email");

    if (!emailInput.hasAttribute("readonly")) {
      emailInput.setAttribute("readonly", true);
    }
    const passwordInput = document.getElementById("edit_password");

    if (passwordInput.hasAttribute("required")) {
      passwordInput.removeAttribute("required");
    }
    passwordInput.placeholder = "Enter new password (optional)";
    const passwordLabel = document.getElementById("password-grp").getElementsByTagName("label")[0];
    passwordLabel.innerText = "Password (leave blank to keep current)"
  }

  function deleteUser(objUser) {
    if (confirm("Are you sure you want to delete " + objUser.full_name + "?")) {
      // Send a DELETE request using fetch
      fetch("/manage_delete_user", {
        method: "DELETE", 
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ user_id: objUser.user_id })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || "User deleted successfully");
        location.reload(); // Refresh page after delete
      })
      .catch(err => console.error(err));
    }
  }
</script>
{% endblock %}